#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

#define SCREEN_WIDTH 128 // OLED width,  in pixels
#define SCREEN_HEIGHT 64 // OLED height, in pixels

Adafruit_SSD1306 oled(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, -1);

// 'Adik Technology Â©', 128x64px
const unsigned char AdikBitmap [] PROGMEM = {
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xf0, 0x00, 0x00, 0x00, 0x00, 0x0f, 0xff, 0x07, 0xe0, 0x1f, 0xc0, 0x1f, 0x01, 0xf0, 0x07, 0x1f, 
  0xf0, 0x00, 0x00, 0x00, 0x00, 0x07, 0xff, 0x07, 0xe0, 0x0f, 0xc0, 0x1e, 0x00, 0xf8, 0xc7, 0x1f, 
  0xf8, 0x00, 0x00, 0x00, 0x00, 0x03, 0xfe, 0x07, 0xe0, 0x07, 0xc0, 0x3c, 0x18, 0x7c, 0xc2, 0x1f, 
  0xfc, 0x00, 0x00, 0x00, 0x00, 0x03, 0xfe, 0x07, 0xe3, 0xc3, 0xc7, 0xf8, 0x7c, 0x7c, 0xc2, 0x1f, 
  0xfe, 0x00, 0x00, 0x00, 0x00, 0x03, 0xfc, 0x47, 0xe3, 0xc3, 0x87, 0xf8, 0xfc, 0x3c, 0xc8, 0x9f, 
  0xff, 0x00, 0x00, 0x00, 0x00, 0x03, 0xfc, 0x47, 0xc3, 0xe3, 0x87, 0xf0, 0xfc, 0x3c, 0xc8, 0x9f, 
  0xff, 0x80, 0x00, 0x00, 0x00, 0x03, 0xf8, 0xe7, 0xc7, 0xe3, 0x80, 0x71, 0xfc, 0x3c, 0xc8, 0x9f, 
  0xff, 0x80, 0x00, 0x00, 0x00, 0x07, 0xf8, 0xe3, 0xc7, 0xc3, 0x80, 0x71, 0xfc, 0x3d, 0xed, 0x9f, 
  0xff, 0xc0, 0x00, 0x00, 0x00, 0x07, 0xf1, 0xe3, 0xc7, 0xc3, 0x80, 0x71, 0xfc, 0x7f, 0xff, 0xff, 
  0xff, 0xe0, 0x00, 0x00, 0x00, 0x07, 0xf0, 0x03, 0xc7, 0xc7, 0x0f, 0xf1, 0xfc, 0x7f, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0x00, 0x07, 0xe0, 0x03, 0x87, 0x87, 0x1f, 0xf1, 0xf8, 0x7f, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xfe, 0x00, 0x0f, 0xe0, 0x03, 0x8f, 0x87, 0x1f, 0xf1, 0xf8, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xfe, 0x00, 0x0f, 0xc7, 0xe3, 0x8e, 0x0f, 0x1f, 0xf0, 0xe0, 0xff, 0xff, 0xff, 
  0xff, 0xe0, 0x00, 0xfe, 0x00, 0x0f, 0xc7, 0xe3, 0x80, 0x1f, 0x00, 0xf8, 0x01, 0xff, 0xff, 0xff, 
  0xff, 0xe0, 0x00, 0xfc, 0x00, 0x0f, 0x8f, 0xe3, 0x00, 0x3e, 0x00, 0xfc, 0x03, 0xff, 0xff, 0xff, 
  0xff, 0xc0, 0x01, 0xfc, 0x00, 0x1f, 0x9f, 0xf3, 0xa7, 0xff, 0x01, 0xff, 0x1f, 0xff, 0xff, 0xff, 
  0xff, 0xc0, 0x00, 0x00, 0x00, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xc0, 0x00, 0x00, 0x00, 0x1f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xc0, 0x00, 0x00, 0x00, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0x80, 0x00, 0x00, 0x00, 0x3f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0x80, 0x00, 0x00, 0x00, 0x3f, 0xff, 0xff, 0xff, 0x3f, 0xff, 0xff, 0xdf, 0xff, 0xff, 0xff, 
  0xff, 0x80, 0x00, 0x00, 0x00, 0x3f, 0x01, 0xff, 0xff, 0x3f, 0xff, 0xff, 0x9f, 0xff, 0xff, 0xff, 
  0xff, 0x00, 0x03, 0xf0, 0x00, 0x7f, 0x01, 0xff, 0xfe, 0x7f, 0xff, 0xff, 0x9f, 0xff, 0xff, 0xff, 
  0xff, 0x00, 0x07, 0xf0, 0x00, 0x7f, 0xcf, 0x87, 0x86, 0x07, 0x67, 0xc7, 0x9c, 0x3c, 0x03, 0x9f, 
  0xff, 0x00, 0x07, 0xf0, 0x00, 0x7f, 0xcf, 0x03, 0x06, 0x07, 0x03, 0x03, 0x98, 0x18, 0x13, 0x9f, 
  0xff, 0x00, 0x07, 0xe0, 0x00, 0x7f, 0xcf, 0x33, 0x3e, 0x66, 0x33, 0x33, 0x11, 0x99, 0x99, 0x3f, 
  0xfe, 0x00, 0x0f, 0xe0, 0x00, 0xff, 0xce, 0x02, 0x7e, 0x66, 0x72, 0x33, 0x33, 0x99, 0x39, 0x3f, 
  0xfe, 0x00, 0x0f, 0xe0, 0x00, 0xff, 0x9e, 0x0e, 0x7c, 0xe6, 0x62, 0x73, 0x33, 0x98, 0x38, 0x7f, 
  0xfe, 0x00, 0x0f, 0xe0, 0x00, 0xff, 0x9e, 0x7e, 0x7c, 0xe6, 0x66, 0x73, 0x33, 0x19, 0xf8, 0x7f, 
  0xfe, 0x00, 0x0f, 0xc0, 0x01, 0xff, 0x9e, 0x26, 0x0c, 0xc6, 0x67, 0x07, 0x30, 0x31, 0xf8, 0xff, 
  0xfc, 0x00, 0x1f, 0xc0, 0x01, 0xff, 0x9f, 0x07, 0x0c, 0xcc, 0xe7, 0x0e, 0x78, 0x70, 0x38, 0xff, 
  0xfc, 0x00, 0x1f, 0xc0, 0x01, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe7, 0x39, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe7, 0x31, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xe0, 0x63, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff
};


#define BLYNK_TEMPLATE_ID "TMPLUV2L_lh7"
#define BLYNK_DEVICE_NAME "FVE"
#define BLYNK_AUTH_TOKEN "Gurl2O0DoNv46y8iKKJmNTx1w15NLJ7l"

#define BLYNK_PRINT Serial

#include <WiFi.h>
#include <WiFiClient.h>
#include <BlynkSimpleEsp32.h>

char auth[] = BLYNK_AUTH_TOKEN;
char ssid[] = "iHome";
char pass[] = "202PuskaS";

#include <PZEM004Tv30.h>

PZEM004Tv30 pzem(Serial2, 16, 17);

BlynkTimer timer;

BLYNK_WRITE(V10) {  // vPin is the Virtual Pin assigned to a Button Widget
 if (param.asInt() == 1) {  
    pzem.resetEnergy();
  }
 Blynk.virtualWrite(V10, 0);
}

void sendSensor()
{
    
  oled.setTextSize(1);         // set text size
  oled.setTextColor(WHITE);    // set text color
  oled.setCursor(0, 10);       // set position to display
  //oled.println("Monitoring siete"); // set text
  //oled.display();             // display on OLED
  oled.clearDisplay(); // clear display

 
    Serial.print("Custom Address:");
    Serial.println(pzem.readAddress(), HEX);
    // Read the data from the sensor
    float voltage = pzem.voltage();
    float current = pzem.current();
    float power = pzem.power();
    float energy = pzem.energy();
    float frequency = pzem.frequency();
    float pf = pzem.pf();

    if(isnan(voltage) || isnan(current) || isnan(power) || isnan(frequency) || isnan(pf)){
        Serial.println("Error reading data");
        oled.setCursor(0, 20);       // set position to display
        oled.println("Chyba pri citani dat"); // set text
        oled.setCursor(0, 35);       // set position to display
        oled.println("Skondroluj napajanie modulu"); // set text
        oled.display();      
        int casovac = 0;
        for (int i=0; i<=3; i++) {
          delay(500);  
          oled.setCursor(35+casovac, 43);    
          oled.println("."); 
          oled.display(); 
          casovac = casovac+5;
          }
        
        
    } else {

        // Print the values to the Serial console
        Serial.print("Voltage: ");      Serial.print(voltage);      Serial.println("V");
        oled.setCursor(0, 10);       // set position to display
        oled.println(voltage, 1); // set text
        oled.setCursor(30, 10);       // set position to display
        oled.println("V"); // set text

        
        Serial.print("Current: ");      Serial.print(current);      Serial.println("A");
        oled.setCursor(50, 10);       // set position to display
        oled.println(current); // set text
        oled.setCursor(90, 10);       // set position to display
        oled.println("A"); // set text

        
        Serial.print("Power: ");        Serial.print(power);        Serial.println("W");
        oled.setCursor(0, 20);       // set position to display
        oled.println(power,1); // set text
        oled.setCursor(35, 20);       // set position to display
        oled.println("W"); // set text        

        
        Serial.print("Energy: ");       Serial.print(energy,3);     Serial.println("kWh");
        oled.setCursor(50, 20);       // set position to display
        oled.println(energy,1); // set text
        oled.setCursor(90, 20);       // set position to display
        oled.println("kWh"); // set text
        
        Serial.print("Frequency: ");    Serial.print(frequency, 1); Serial.println("Hz");
        oled.setCursor(0, 30);       // set position to display
        oled.println(frequency, 1); // set text
        oled.setCursor(25, 30);       // set position to display
        oled.println("Hz"); // set text   
        
        Serial.print("PF: ");           Serial.println(pf);
        oled.setCursor(50, 30);       // set position to display
        oled.println(pf); // set text
        oled.setCursor(90, 30);       // set position to display
        oled.println("PF"); // set text
        oled.display();  
    
        Blynk.virtualWrite(V100, voltage);
        Blynk.virtualWrite(V101, current);
        Blynk.virtualWrite(V102, power);
        Blynk.virtualWrite(V103, energy);
        Blynk.virtualWrite(V104, frequency);
        Blynk.virtualWrite(V105, pf);
    }
}


void setup()
{
  Serial.begin(9600);

  Blynk.begin(auth, ssid, pass);

  if (!oled.begin(SSD1306_SWITCHCAPVCC, 0x3C)) {
    Serial.println(F("failed to start SSD1306 OLED"));
    while (1);
  }
    oled.clearDisplay(); // clear display
    oled.drawBitmap(0,0, AdikBitmap, 128, 64, 1);
    oled.display();
    delay(3000);         
    oled.clearDisplay(); 
  
    timer.setInterval(1000L, sendSensor);
    


  delay(2000);         
  oled.clearDisplay(); 
}

void loop()
{ 
  Blynk.run();
  timer.run();
}
